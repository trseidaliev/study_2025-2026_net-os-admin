---
## Front matter
title: "Отчёт по лабораторной работе 3"
subtitle: "Настройка DHCP-сервера"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DHCPсервера.

# Выполнение

## Конфигурирование DHCP-сервера

Перед началом настройки была выполнена резервная копия конфигурационного файла Kea DHCP.

После открытия файла `/etc/kea/kea-dhcp4.conf` внесены изменения в параметры домена.  
В блоке `option-data` значения `domain-name` и `domain-search` заменены на домен вида `<логин>.net`,  
а список DNS-серверов заменён на `192.168.1.1`.

![Фрагмент kea-dhcp4.conf с параметрами домена и DNS](Screenshot_1.png){ #fig:001 width=80% }

Создана собственная конфигурация подсети:  
задана сеть `192.168.1.0/24`, диапазон выдаваемых адресов `192.168.1.30–192.168.1.199`,  
и указан адрес шлюза `192.168.1.1`.

![Конфигурация подсети DHCP](Screenshot_2.png){ #fig:002 width=80% }

DHCP-сервер настроен на работу через интерфейс `eth1`, что зафиксировано  
в параметре `interfaces-config`.

Произведена проверка конфигурации и перезагрузка службы DHCP.  
Также включена автоматическая загрузка сервиса при старте системы.

![Проверка и включение службы kea-dhcp4](Screenshot_3.png){ #fig:003 width=95% }

В конце файла `/var/named/master/fz/<логин>.net` добавлена запись

Также обновлён серийный номер зоны.

![Файл прямой зоны после изменения](Screenshot_4.png){ #fig:004 width=70% }

В файл `/var/named/master/rz/192.168.1` добавлена PTR-запись

Серийный номер зоны обновлён.

![Файл обратной зоны](Screenshot_5.png){ #fig:005 width=80% }

После перезапуска DNS-сервера выполнена проверка доступности DHCP-узла по имени.

![Проверка ping по имени dhcp.<логин>.net](Screenshot_6.png){ #fig:006 width=80% }

В межсетевом экране разрешена служба DHCP,  
а также восстановлены контексты безопасности SELinux для каталогов  
`/etc`, `/var/named` и `/var/lib/kea`.

![Изменения в firewall и SELinux](Screenshot_7.png){ #fig:007 width=85% }

## Анализ работы DHCP-сервера

Для корректной работы клиентской машины был создан скрипт `01-routing.sh`,  
который изменяет параметры NetworkManager, направляя весь исходящий трафик через интерфейс `eth1`.  
Скрипт прописан в каталоге `vagrant/provision/client` и подключён в секции конфигурации клиента в `Vagrantfile`.  
После запуска провижининга клиентской машины настройки применились:

![Скрипт настройки маршрутизации клиента](Screenshot_8.png){ #fig:008 width=70% }

После запуска виртуальной машины client выполнена проверка сетевых интерфейсов.  
Интерфейс `eth1` успешно получил IP-адрес из диапазона DHCP-сервера:

![Вывод ifconfig на клиенте](Screenshot_9.png){ #fig:009 width=80% }

Построчный анализ:

- `eth1` — активный интерфейс, через который осуществляется подключение к внутренней сети.  
- `inet 192.168.1.30` — клиент получил адрес из диапазона `192.168.1.30–192.168.1.199`, что подтверждает корректную работу DHCP.  
- `netmask 255.255.255.0` — маска подсети соответствует сети `192.168.1.0/24`.  
- `broadcast 192.168.1.255` — широковещательный адрес установлен автоматически.  
- `ether 08:00:27:36:98:16` — MAC-адрес интерфейса, используемый DHCP-сервером для идентификации клиента.  
- Статистика RX/TX показывает обмен пакетами внутри сети — интерфейс функционирует.

Интерфейс `lo` — стандартный Loopback, работает корректно.

На сервере зафиксировано несколько записей в файле `/var/lib/kea/kea-leases4.csv`:

![Содержимое файла kea-leases4.csv](Screenshot_10.png){ #fig:010 width=90% }

Построчное объяснение (формат Kea):

- **192.168.1.30** — IP, выданный клиенту.  
- **08:00:27:36:98:16** — MAC-адрес клиента.  
- **01:08:00:27:36:98:16** — client-id, автоматически сгенерированный.  
- **3600** — время аренды в секундах (1 час).  
- **1763571977** — timestamp истечения аренды.  
- **1** — ID подсети (subnet4 ID = 1).  
- **0,0** — FQDN обновления (вперёд/назад) отключены.  
- **client** — имя хоста.  
- **0** — поле состояния (lease active).  
- **0** — ID пула, из которого выдан адрес.

## Настройка обновления DNS-зоны

Для обеспечения автоматического создания A- и PTR-записей при появлении новых клиентов в сети была выполнена настройка механизма **DDNS (Dynamic DNS Updates)** между Kea DHCP и Bind9.

На сервере была создана директория для ключей и сформирован TSIG-ключ для авторизации обновлений:

![Создание ключа DHCP_UPDATER](Screenshot_11.png){ #fig:011 width=90% }

После генерации ключа были установлены корректные права доступа:

В файл `/etc/named.conf` добавлено подключение ключа:

![Включение ключа в named.conf](Screenshot_12.png){ #fig:013 width=80% }

В файле зоны `<логин>.net` указано правило обновления:

![Разрешение обновлений в прямой зоне](Screenshot_13.png){ #fig:014 width=80% }

В обратной зоне `1.168.192.in-addr.arpa` аналогично разрешены обновления PTR-записей:

![Разрешение обновлений в обратной зоне](Screenshot_14.png){ #fig:015 width=80% }

После внесения изменений конфигурация проверена

DNS-сервер перезапущен.

Создан файл `/etc/kea/tsig-keys.json` и в него перенесён ключ в формате JSON:

![Файл tsig-keys.json](Screenshot_15.png){ #fig:016 width=80% }

Установлены права и назначен владелец

В файл `/etc/kea/kea-dhcp-ddns.conf` добавлены параметры для forward и reverse обновлений:

![Фрагмент kea-dhcp-ddns.conf](Screenshot_16.png){ #fig:017 width=90% }

Особенно важно наличие точки в конце имён зон (`user.net.` и `1.168.192.in-addr.arpa.`),  
иначе обновления будут завершаться ошибкой.

Файл проверен на корректность

Служба запущена и активирована:

![Запуск службы kea-dhcp-ddns](Screenshot_17.png){ #fig:018 width=90% }

В основной конфигурации DHCP включено использование DDNS

После внесения изменений конфигурация проверена и DHCP-сервер перезапущен:

![Проверка и запуск Kea DHCP4](Screenshot_18.png){ #fig:019 width=90% }

На клиентской машине адрес был переполучен

После получения IP-адреса DHCP-сервер инициирует обновление DNS-записей.  
В каталоге прямой зоны появился файл-журнал динамических обновлений

## Анализ работы DHCP-сервера после настройки обновления DNS-зоны

После завершения настройки DDNS был выполнен тест с клиентской машины.  
С помощью утилиты **dig** отправлен запрос к DNS-серверу (192.168.1.1) для проверки присутствия динамически созданной записи:

![Результат выполнения dig](Screenshot_19.png){ #fig:020 width=80% }

Построчный разбор:

- `; <<>> DiG 9.18.33 <<>> @192.168.1.1 client.trseidAliev.net`  
  Утилита dig отправляет запрос к DNS-серверу по адресу 192.168.1.1 на получение A-записи клиентского хоста.

- `;; Got answer:`  
  Получен корректный ответ от DNS-сервера.

- `;; ->>HEADER<<- opcode: QUERY, status: NOERROR`  
  Запрос выполнен успешно, ошибок нет. Статус `NOERROR` означает, что доменное имя найдено.

- `qr aa rd ra`  
  - `qr` — ответ является ответом сервера  
  - `aa` — authoritative answer (сервер является авторитетным для зоны)  
  - `rd/ra` — recursion desired/available (рекурсия доступна)

- `QUESTION SECTION:`  
  `client.trseidAliev.net.   IN   A`  
  Указано имя хоста, тип записи A — запрос IPv4-адреса.

- `ANSWER SECTION:`  
  `client.trseidAliev.net. 1200 IN A 192.168.1.30`  
  DNS-сервер сообщает, что имя `client.<логин>.net` связано с адресом **192.168.1.30**,  
  что подтверждает успешное динамическое создание записи DHCP-DDNS.

- `SERVER: 192.168.1.1#53`  
  Ответ получен от локального DNS-сервера Bind9.

- `MSG SIZE rcvd: 95`  
  Размер полученного сообщения — 95 байт.

## Внесение изменений в настройки внутреннего окружения виртуальной машины

Для автоматизации развёртывания DHCP и DNS был подготовлен перенос текущих конфигураций серверных служб в директорию Vagrant.

В каталоге provisioning создана структура директорий для DHCP. В неё скопированы все актуальные файлы конфигурации DHCP-сервер.

В каталоге `/vagrant/provision/server` создан сценарий автоматической установки и запуска Kea DHCP/DDNS:

Фрагмент файла:

![Содержимое dhcp.sh](Screenshot_20.png){ #fig:021 width=80% }

# Заключение

В ходе выполнения работы:

- настроено динамическое обновление DNS-зон на основе взаимодействия Kea DHCP и Bind9 c использованием TSIG-ключей;
- сконфигурированы прямые и обратные зоны DNS с разрешением на автоматическое внесение A- и PTR-записей;
- подготовлены и подключены конфигурации Kea DHCP для работы механизма DDNS, включая файлы `tsig-keys.json` и `kea-dhcp-ddns.conf`;
- выполнена проверка работы службы DDNS и зафиксировано успешное создание динамических DNS-записей для клиента;
- подтверждена корректность функционирования DNS посредством запроса `dig`, показавшего автоматическое появление записи клиента в зоне;
- экспортированы текущие конфигурации DHCP и DNS в структуру каталога Vagrant для дальнейшей автоматизации;
- создан и настроен сценарий `dhcp.sh`, обеспечивающий автоматическое развёртывание Kea DHCP и Kea DDNS при последующих запусках проекта.

# Контрольные вопросы

## 1. В каких файлах хранятся настройки сетевых подключений?

Настройки сетевых подключений хранятся в следующих файлах:

- в системах семейства RHEL/CentOS/Rocky Linux:  
  `/etc/sysconfig/network-scripts/ifcfg-<интерфейс>` — основной файл конфигурации каждого сетевого интерфейса;

- в NetworkManager:  
  `/etc/NetworkManager/system-connections/<профиль>.nmconnection` — профили сетевых подключений;

- общесистемные параметры сети:  
  `/etc/sysconfig/network` — базовые сетевые настройки (шлюз,hostname, маршрутизация).

Эти файлы определяют IP-адреса, маску сети, шлюз, DNS-серверы, режим работы интерфейсов и прочие параметры сети.

## 2. За что отвечает протокол DHCP?

DHCP (Dynamic Host Configuration Protocol) отвечает за автоматическое назначение сетевых параметров клиентам в сети.  
Основные функции:

- выдача IP-адресов из пула;  
- передача маски сети, шлюза по умолчанию, DNS-серверов;  
- управление временем аренды IP-адреса;  
- автоматизация настройки сетевых устройств без ручной конфигурации.

## 3. Поясните принцип работы протокола DHCP. Какими сообщениями обмениваются клиент и сервер?

Работа DHCP основана на механизме аренды IP-адреса и проходит в четыре этапа (DORA):

1. **DHCPDISCOVER** — клиент ищет DHCP-сервер, отправляя широковещательный запрос.
2. **DHCPOFFER** — сервер предлагает клиенту свободный IP-адрес.
3. **DHCPREQUEST** — клиент выбирает один из предложенных адресов и запрашивает его назначение.
4. **DHCPACK** — сервер подтверждает аренду и передаёт клиенту полный набор сетевых параметров.

При обновлении аренды используются сообщения:

- **DHCPREQUEST** — запрос продления,
- **DHCPACK** — подтверждение,
- **DHCPNAK** — отказ при недоступности адреса.

## 4. В каких файлах обычно находятся настройки DHCP-сервера? За что отвечает каждый из файлов?

Типичные файлы конфигурации Kea DHCP находятся в каталоге:

`/etc/kea/`

Основные файлы:

- **kea-dhcp4.conf** — конфигурация IPv4 DHCP-сервера (пулы адресов, опции, подсети, интерфейсы).
- **kea-dhcp-ddns.conf** — настройки динамического обновления DNS.
- **tsig-keys.json** — ключи авторизации для взаимодействия Kea с Bind9.
- **kea.conf** (если есть) — глобальная конфигурация Kea.

Файлы зоны DNS для работы DDNS расположены в:

`/var/named/` — хранят A- и PTR-записи, которые обновляются DHCP-сервером.

## 5. Что такое DDNS? Для чего применяется DDNS?

**DDNS (Dynamic DNS)** — механизм автоматического обновления DNS-записей о хостах.  
Используется для:

- автоматического добавления A- и PTR-записей в DNS при появлении новых клиентов DHCP;  
- упрощения администрирования сети — DNS всегда содержит актуальные имена и IP-адреса;  
- повышения автоматизации и уменьшения ручных действий администратора.

Kea DHCP обновляет Bind9 через защищённое TSIG-взаимодействие.

## 6. Какую информацию можно получить, используя утилиту ifconfig? Приведите примеры с использованием различных опций.

`ifconfig` позволяет получить сведения о сетевых интерфейсах:

- IP-адреса (IPv4/IPv6);  
- MAC-адрес;  
- маску сети;  
- состояние интерфейсов (UP/DOWN);  
- статистику пакетов (RX/TX);  
- параметры MTU.

### Примеры:

- `ifconfig` — отображает все активные интерфейсы.  
- `ifconfig eth0` — информация только по указанному интерфейсу.  
- `ifconfig eth1 down` — выключение интерфейса.  
- `ifconfig eth1 up` — включение интерфейса.  

## 7. Какую информацию можно получить, используя утилиту ping? Приведите примеры с использованием различных опций.

Утилита `ping` используется для проверки доступности узлов в сети. Она показывает:

- факт доступности хоста;  
- время отклика (RTT);  
- процент потерь пакетов;  
- работу маршрутизации;  
- качество соединения.

### Примеры:

- `ping 192.168.1.1` — проверка доступности маршрутизатора.  
- `ping -c 4 google.com` — отправка 4 пакетов и завершение.  
- `ping -i 0.5 8.8.8.8` — интервал 0.5 секунды между пакетами.  
- `ping -s 1500 host` — отправка пакетов увеличенного размера.  
