---
## Front matter
title: "Отчёт по лабораторной работе 13"
subtitle: "Настройка NFS"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---


# Цель работы

Приобретение навыков настройки сервера NFS для удалённого доступа к ресурсам.

# Выполнение

## Настройка NFSv4 сервера и клиента

### Развёртывание и подготовка NFS-сервера

На сервере установлено необходимое ПО для работы NFS, после чего создан корневой каталог экспортируемого дерева. В файл `/etc/exports` добавлена запись, предоставляющая доступ всем клиентам сети в режиме только чтение.

![Установка nfs-utils и создание каталога /srv/nfs](Screenshot_1.png){ #fig:001 width=90% }

Файл `/etc/exports` после настройки содержит строку с экспортируемым каталогом:

```
/srv/nfs *(ro)
```

![Настройка экспорта каталога /srv/nfs](Screenshot_2.png){ #fig:002 width=45% }

### Настройка SELinux и запуск NFS

Для каталога `/srv/nfs` назначен контекст безопасности `nfs_t`, после чего изменения применены к файловой системе. Далее служба NFS была запущена, добавлена в автозагрузку, а в firewall разрешён сервис NFS.

![Настройка SELinux и запуск NFS-сервера](Screenshot_3.png){ #fig:003 width=95% }

## Проверка работы с клиента

На клиенте установлено ПО NFS, после чего выполнена команда для просмотра экспортированных ресурсов. Запрос завершается ошибкой из-за того, что часть RPC-служб была заблокирована межсетевым экраном.

![Ошибка RPC при выполнении showmount](Screenshot_4.png){ #fig:004 width=80% }

Команда обращается к RPC-службам `mountd` и `rpcbind`. Пока соответствующие порты не разрешены firewall, клиент не может получить ответ — возникает ошибка RPC.

После остановки firewall повторная попытка получить список экспортов проходит успешно. Это подтверждает, что причиной ошибки действительно были заблокированные порты RPC.

![Успешный showmount при отключённом firewall](Screenshot_6.png){ #fig:005 width=55% }

Межсетевой экран затем был снова включён.

Для идентификации используемых служб были просмотрены активные TCP- и UDP-порты. В выводе обнаружены сервисы `rpcbind`, `rpc.statd`, `mountd`. Эти службы были добавлены в firewall, что позволило корректно выполнять запросы NFS-клиента.

![Просмотр задействованных служб и добавление mountd/rpc-bind в firewall](Screenshot_5.png){ #fig:006 width=95% }

После добавления служб в правила firewall запрос `showmount` снова выполняется успешно:

## Монтирование NFS на клиенте

На клиенте создан каталог для точки монтирования. После подключения ресурса проверка показывает, что файловая система смонтирована корректно и работает через протокол NFS версии 4.2.

![Проверка монтирования /mnt/nfs](Screenshot_8.png){ #fig:007 width=90% }

**Пояснение параметров монтирования:**

- используется протокол NFSv4,
- транспорт — TCP,
- указаны размеры блоков, параметры таймаутов,
- отображён IP-адрес клиента,
- ресурс успешно подмонтирован в `/mnt/nfs`.

В `/etc/fstab` добавлена строка для автоматического подключения ресурса при загрузке системы:

```
server.trseidaliev.net:/srv/nfs /mnt/nfs nfs _netdev 0 0
```

![Запись NFS в /etc/fstab на клиенте](Screenshot_7.png){ #fig:008 width=80% }

**Пояснение синтаксиса:**

- первая часть — путь к экспортируемому каталогу сервера,
- вторая — локальная точка монтирования,
- тип — NFS,
- `_netdev` — отложенное монтирование до поднятия сети,
- `0 0` — отключены dump и fsck.

Проверка состояния `remote-fs.target` подтверждает, что автоматическое монтирование работает корректно. После перезапуска клиент автоматически подключает удалённый ресурс.

## Добавление веб-контента в экспортируемое дерево

На сервере создан каталог `/srv/nfs/www`, в который через bind было подключено содержимое `/var/www`. Теперь веб-контент стал частью экспортируемой структуры.

В файл `/etc/exports` добавлена строка:

```
/srv/nfs/www 192.168.0.0/16(rw)
```

![Экспорт каталога /srv/nfs/www](Screenshot_9.png){ #fig:009 width=45% }

После обновления экспорта клиенты получают доступ к содержимому, доступному в каталоге `/srv/nfs/www`.

В файл `/etc/fstab` на сервере внесена строка:

```
/var/www /srv/nfs/www none bind 0 0
```

![Запись bind-монтирования в /etc/fstab на сервере](Screenshot_10.png){ #fig:010 width=90% }

Эта запись обеспечивает автоматическое подключение каталога веб-сервера в дерево NFS при каждом запуске системы.

После добавления экспорта каталога веб-сервера и записи bind-монтирования в `/etc/fstab` на сервере были повторно экспортированы каталоги, указанные в `/etc/exports`.  
Каталог `/srv/nfs` теперь содержит подкаталог `www`, соответствующий привязанному (`bind`) каталогу `/var/www`.

![Содержимое /srv/nfs и повторный экспорт каталогов](Screenshot_11.png){ #fig:011 width=70% }

На клиенте при проверке каталога `/mnt/nfs` отображается подкаталог `www`, что подтверждает доступность экспортированного дерева NFS.

![Появление каталога www на клиенте в /mnt/nfs](Screenshot_12.png){ #fig:012 width=55% }

## Подключение каталогов для работы пользователей

### Создание пользовательского каталога и файла на сервере

Под пользователем `trseidaliev` в домашнем каталоге создан каталог `common` с правами доступа `700`, то есть полный доступ только у владельца. Внутри каталога создан файл `trseidaliev@server.txt`.

![Создание каталога common и файла trseidaliev@server.txt](Screenshot_13.png){ #fig:013 width=80% }

Таким образом:

- только пользователь `trseidaliev` имеет доступ к содержимому `~/common`;
- остальные пользователи, включая `root` при обращении по NFS (с учётом механизма `root_squash`), не могут читать или изменять этот каталог.

### Экспорт пользовательского каталога по NFS

На сервере создан каталог `/srv/nfs/home/trseidaliev`, в который затем будет подмонтирован каталог `common`.  
В файле `/etc/exports` добавлен экспорт пользовательского каталога:

- строка `/srv/nfs/home/trseidaliev 192.168.0.0/16(rw)` разрешает доступ на чтение и запись всем хостам из подсети `192.168.0.0/16`.

![Добавление экспорта пользовательского каталога в /etc/exports](Screenshot_14.png){ #fig:014 width=70% }

В том же файле `/etc/fstab` настроено bind-монтирование:

- строка `/home/trseidaliev/common /srv/nfs/home/trseidaliev none bind 0 0` обеспечивает автоматическое подключение каталога `common` в дерево `/srv/nfs/home`.

![Запись bind-монтирования пользовательского каталога в /etc/fstab](Screenshot_15.png){ #fig:015 width=90% }

Далее каталоги были повторно экспортированы, после чего пользовательский каталог стал доступен по NFS:

![Создание каталога /srv/nfs/home/trseidaliev, bind-монтирование и повторный exportfs](Screenshot_16.png){ #fig:016 width=90% }

### Проверка работы на клиенте

На клиенте в каталоге `/mnt/nfs` теперь видна структура `home/www`.  
Пользователь `trseidaliev` переходит в каталог `/mnt/nfs/home/trseidaliev` и создаёт файл `trseidaliev@client.txt`. В результате в каталоге отображаются два файла: `trseidaliev@server.txt` и `trseidaliev@client.txt`.

Попытка зайти в тот же каталог с клиента под пользователем `root` завершается ошибкой `Permission denied`. Это связано с тем, что:

- каталог `/home/trseidaliev/common` на сервере имеет права `700`;
- на стороне NFS включён механизм `root_squash`, который подменяет пользователя `root` на клиентах на непривилегированного пользователя, не имеющего прав доступа к каталогу.

![Создание файла на клиенте, отказ в доступе для root и итоговый список файлов](Screenshot_17.png){ #fig:017 width=95% }

На сервере в каталоге `~/common` видны оба файла — и созданный на сервере, и созданный на клиенте. Это подтверждает корректную синхронизацию содержимого каталога через NFS.

![Просмотр файлов в каталоге common на сервере](Screenshot_18.png){ #fig:018 width=80% }

##  Внесение изменений в настройки внутреннего окружения VM

На виртуальной машине `server` в каталоге `/vagrant/provision/server` создан подкаталог `nfs/etc`. В него скопирован конфигурационный файл `/etc/exports`.  
Это позволяет хранить «шаблон» настроек экспорта внутри каталога, доступного Vagrant, и использовать его при автоматическом развертывании стенда.

В каталоге `/vagrant/provision/server` создан исполняемый файл `nfs.sh`.  

![Фрагмент скрипта nfs.sh на сервере](Screenshot_19.png){ #fig:019 width=80% }

В результате при автоматическом провижининге VM `server` весь набор настроек NFS (экспорты, firewall, SELinux, bind-монтирования и пользовательские каталоги) разворачивается автоматически.

На виртуальной машине `client` в каталоге `/vagrant/provision/client` создан исполняемый файл `nfs.sh`.  

![Фрагмент скрипта nfs.sh на клиенте](Screenshot_20.png){ #fig:020 width=80% }

# Заключение

В ходе выполнения работы:

- настроен сервер NFSv4 с учётом SELinux и межсетевого экрана;
- подготовлены каталоги для экспорта, включая пользовательские и системные (`www`, `home/user/common`);
- выполнено bind-монтирование каталогов в дерево NFS;
- настроены автоматические подключения через `/etc/fstab` на сервере и клиенте;
- корректно организована работа пользовательских каталогов с учётом прав доступа и механизма `root_squash`;
- созданы скрипты автоматического провижининга для серверной и клиентской виртуальной машины.

# Контрольные вопросы

## 1. Как называется файл конфигурации, содержащий общие ресурсы NFS?

Файл конфигурации, в котором перечислены экспортируемые сервером каталоги NFS, называется:

```
/etc/exports
```

В нём задаются пути, параметры доступа и список клиентов, которым разрешено подключение.

## 2. Какие порты должны быть открыты в брандмауэре, чтобы обеспечить полный доступ к серверу NFS?

Для корректной работы NFS необходимо разрешить доступ к следующим службам:

- **nfs** — основной сервис NFS;
- **rpc-bind** — назначение динамических RPC-портов;
- **mountd** — обслуживание запросов `mount` и `showmount`.

Эти службы автоматически открывают необходимые порты, включая:

- 2049/tcp — порт NFSv4;
- 111/tcp и 111/udp — порт rpcbind;
- динамические порты для mountd и rpc.statd.

## 3. Какую опцию следует использовать в /etc/fstab, чтобы убедиться, что общие ресурсы NFS могут быть установлены автоматически при перезагрузке?

Для автоматического монтирования сетевых ресурсов NFS при загрузке используется опция:

```
_netdev
```

Она указывает системе, что устройство зависит от сети, и его следует монтировать только после поднятия сетевых служб. Это предотвращает ошибки при загрузке и обеспечивает корректное подключение NFS-ресурсов.

