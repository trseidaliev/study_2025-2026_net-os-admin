---
## Front matter
title: "Отчёт по лабораторной работе 2"
subtitle: "Настройка DNS-сервера"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---


# Цель работы

Приобретение практических навыков по установке и конфигурированию DNSсервера, усвоение принципов работы системы доменных имён.

# Выполнение

## Установка DNS-сервера

После установки пакетов bind и bind-utils была выполнена проверка DNS-разрешения с помощью утилиты dig по адресу www.yandex.ru.

В выводе отражается типичная структура DNS-ответа:

- HEADER содержит идентификатор запроса, результат выполнения (NOERROR) и параметры запроса.
- QUESTION SECTION включает доменное имя и тип записи (A).
- ANSWER SECTION содержит три найденных A-записи с IP-адресами сервера.
- Query time показывает задержку ответа.
- SERVER указывает DNS-сервер, обработавший запрос (10.0.2.3).
- MSG SIZE — размер полученного сообщения.

![Результат команды dig до настройки локального DNS](Screenshot_1.png){ #fig:001 width=80% }

## Конфигурирование кэширующего DNS-сервера

Файл /etc/resolv.conf

До настройки собственного DNS-сервера хост использовал внешний DNS:

- search trseidalev.net — домен поиска;
- nameserver 10.0.2.3 — основной DNS-сервер.

Файл /etc/named.conf содержит базовую конфигурацию кэширующего DNS-сервера:

- listen-on ограничивает прослушивание портов только адресом 127.0.0.1;
- allow-query задаёт разрешение обработке запросов только с localhost;
- указаны пути к служебным файлам статистики, дампов и корневых ключей.

![Начальная конфигурация named.conf](Screenshot_2.png){ #fig:003 width=80% }

Файл /var/named/named.ca содержит список корневых DNS-серверов. В нём представлены:

- NS-записи корневых серверов;
- A и AAAA-адреса этих серверов;
- метаданные: дата обновления и версия зоны.

![Содержимое named.ca](Screenshot_3.png){ #fig:004 width=80% }

Файл /var/named/named.localhost описывает локальную зону hostname → адрес:

- SOA — основная запись зоны;
- NS — сервер имён;
- A и AAAA для адресов 127.0.0.1 и ::1.

Файл /var/named/named.loopback отвечает за зону обратного разрешения 127.0.0.0/8:

- SOA — запись зоны;
- NS — сервер имён;
- PTR localhost — обратное разрешение.

![Содержимое локальных зон](Screenshot_4.png){ #fig:005 width=80% }

После запуска службы named и её добавления в автозапуск был произведён запрос через локальный DNS-сервер по адресу 127.0.0.1.

Вывод показал корректное выполнение запроса и кэширование.

![Результат dig через 127.0.0.1](Screenshot_5.png){ #fig:006 width=80% }

В настройках интерфейса eth0 были изменены параметры:

- удалён внешний DNS;
- включён ignore-auto-dns;
- установлен DNS 127.0.0.1.

После перезапуска NetworkManager содержимое /etc/resolv.conf обновилось, и в нём стал указан локальный DNS.

![Настройка DNS через nmcli](Screenshot_6.png){ #fig:007 width=80% }

В файл /etc/named.conf внесены изменения:

- listen-on расширен до 127.0.0.1 и any, что позволяет слушать порт 53 на всех интерфейсах;
- allow-query дополнен подсетью 192.168.0.0/16, что позволяет обслуживать запросы всех хостов локальной сети.

![Изменения в named.conf](Screenshot_7.png){ #fig:008 width=80% }

Для разрешения работы DNS-сервиса в firewall были добавлены соответствующие правила для порта 53 (UDP/TCP). Это обеспечивает доступность DNS-сервера для внутренней сети.

Команда lsof показала, что процесс named корректно прослушивает порт 53/udp, что подтверждает успешную настройку сервера.

![Прослушивание порта 53 UDP](Screenshot_8.png){ #fig:009 width=80% }

## Конфигурирование первичного DNS-сервера

После копирования шаблона `named.rfc1912.zones` в каталог `/etc/named` файл был переименован в `trseidalev.net`. Затем он был подключён в основном конфигурационном файле DNS-сервера посредством строки include.

![Фрагмент named.conf с подключением файла зоны](Screenshot_9.png){ #fig:010 width=80% }

В файле `/etc/named/trseidalev.net` были удалены все лишние записи и добавлены две зоны:

- прямая зона `trseidalev.net`;
- обратная зона `1.168.192.in-addr.arpa`.

![Содержимое файла trseidalev.net](Screenshot_10.png){ #fig:011 width=80% }

В каталоге `/var/named` созданы подкаталоги:

- `master/fz` для прямой зоны;
- `master/rz` для обратной зоны.

Далее в подкаталог `master/fz` был перенесён шаблон прямой зоны и переименован в `trseidalev.net`. Файл был изменён согласно требованиям: корректно прописаны SOA-запись, адрес узла, имя домена и A-записи для серверов.

Итоговое содержимое файла прямой зоны:

![Прямая зона trseidalev.net](Screenshot_11.png){ #fig:012 width=80% }

Шаблон обратной зоны `named.loopback` был перенесён в каталог `master/rz` и переименован в `192.168.1`. После редактирования в файле были указаны необходимые PTR-записи.  

Итоговый вариант файла обратной зоны:

![Обратная зона 192.168.1](Screenshot_12.png){ #fig:013 width=80% }

Для корректной работы демона named права каталогов `/etc/named` и `/var/named` были изменены. После этого были восстановлены контексты SELinux, а также проверены переключатели для службы.  

В выводе видно:

- параметр `named_write_master_zones` включён, что обеспечивает возможность записи в мастер-зоны;
- контексты SELinux восстановлены.

![Настройка прав и SELinux](Screenshot_13.png){ #fig:014 width=90% }

В отдельной консоли был запущен просмотр системного журнала в реальном времени. После перезапуска службы named в логах не появилось ошибок, что подтверждает корректность конфигурации прямой и обратной зон.

DNS-сервер успешно обработал файлы зон и начал обслуживать запросы.

## Анализ работы DNS-сервера

Для проверки прямой зоны был выполнен запрос к адресу ns.trseidalev.net через локальный DNS-сервер.  
Ответ содержит одну A-запись, корректно указывающую на адрес 192.168.1.1. Это подтверждает правильность настройки файла прямой зоны.

![Результат dig ns.trseidalev.net](Screenshot_14.png){ #fig:015 width=80% }

Команда `host -l trseidalev.net`

Эта команда выполняет перечисление всех DNS-записей в зоне.  
Вывод показывает:

- A-записи server.trseidalev.net и ns.trseidalev.net;
- корректное разрешение доменных имён.

Команда `host -a trseidalev.net`

Запрос полного описания зоны (ANY) показывает:

- SOA-запись с корректными параметрами;
- NS-запись, указывающую на основной DNS-сервер;
- A-запись зоны, совпадающую с адресом сервера.

Команда `host -t A trseidalev.net`

Домен корректно разрешается в адрес 192.168.1.1.

Команда `host -t PTR 192.168.1.1`

Обратная зона настроена корректно — IP-адрес 192.168.1.1 соответствует именам server.trseidalev.net и ns.trseidalev.net.

![Проверка зон через host](Screenshot_15.png){ #fig:016 width=95% }

# Внесение изменений в настройки внутреннего окружения виртуальной машины

В каталоге /vagrant/provision/server был создан подкаталог dns с необходимой структурой для хранения конфигурации DNS-сервера. В него были скопированы:

- файл named.conf;
- содержимое каталога /etc/named;
- мастер-зоны из /var/named/master/.

Это позволяет автоматически разворачивать DNS-конфигурацию при создании виртуальной машины.

В каталоге /vagrant/provision/server был создан исполняемый файл dns.sh

Скрипт полностью автоматизирует подготовку DNS-сервера.

![Содержимое скрипта dns.sh](Screenshot_16.png){ #fig:017 width=80% }

# Заключение

В ходе выполнения работы:

- установлен и настроен кэширующий DNS-сервер на базе BIND;
- проанализированы файлы конфигурации резолвера и сервера DNS, включая прямые и обратные зоны;
- выполнена настройка локального DNS-сервера как основного для хоста и внутренней сети;
- добавлены необходимые правила в межсетевой экран и проверена работа сервиса через анализ прослушиваемых портов;
- создана и сконфигурирована прямая зона `trseidalev.net` и обратная зона `1.168.192.in-addr.arpa`;
- проверена корректность работы DNS-записей с помощью утилит `dig` и `host`;
- выполнена автоматизация конфигурации DNS-сервера с сохранением всех нужных файлов в каталог `/vagrant/provision/server/dns` и созданием скрипта `dns.sh`;
- подтверждена корректная работа DNS после перезапуска службы и анализа системного журнала.

# Контрольные вопросы

## 1. Что такое DNS?

DNS — распределённая система, преобразующая доменные имена в IP-адреса и обратно.  
Она обеспечивает удобный доступ к ресурсам сети, позволяя использовать имена вместо числовых адресов.

## 2. Каково назначение кэширующего DNS-сервера?

Кэширующий DNS-сервер сохраняет результаты ранее выполненных запросов.  
Это ускоряет последующие обращения, снижает нагрузку на внешние DNS-серверы и уменьшает сетевой трафик.

## 3. Чем отличается прямая DNS-зона от обратной?

Прямая зона сопоставляет доменные имена IP-адресам (A/AAAA-записи).  
Обратная зона выполняет обратное преобразование — связывает IP-адреса с доменными именами (PTR-записи).

## 4. Где располагаются настройки DNS-сервера и за что они отвечают?

Основные файлы:

- `/etc/named.conf` — базовая конфигурация службы named.  
- `/etc/named/*` — описания подключаемых зон и дополнительных параметров.  
- `/var/named/` — каталоги и файлы мастер- и slave-зон.  
- `/var/named/master/*` — файлы прямых и обратных зон, содержащие записи DNS.

## 5. Что указывается в файле resolv.conf?

В нём задаются параметры резолвера клиента:  
список DNS-серверов (`nameserver`), домен поиска (`search`) и дополнительные настройки.

## 6. Какие типы ресурсов существуют в DNS?

Основные записи:

- **A** — IPv4-адрес.  
- **AAAA** — IPv6-адрес.  
- **NS** — серверы имён зоны.  
- **SOA** — начало зоны и параметры обновления.  
- **PTR** — обратное разрешение IP-адресов.  
- **MX** — почтовые серверы домена.  
- **CNAME** — каноническое имя (псевдоним).  
- **TXT** — произвольные текстовые данные.  
- **SRV** — службы и их порты.

## 7. Для чего используется домен in-addr.arpa?

Для обратного DNS-разрешения IPv4-адресов — сопоставляет IP-адрес доменному имени через PTR-записи.

## 8. Для чего нужен демон named?

named — основной процесс BIND, выполняющий роль DNS-сервера:  
обрабатывает запросы, обслуживает зоны, ведёт кэш и взаимодействует с другими серверами имен.

## 9. Основные функции master- и slave-серверов

- **Master** хранит оригинальные файлы зон и предоставляет их для обновления slave-серверов.  
- **Slave** получает зоны с master и обеспечивает отказоустойчивое обслуживание запросов.

## 10. Какие параметры отвечают за время обновления зоны?

В секции SOA:

- **serial** — версия зоны.  
- **refresh** — период проверки изменений slave-сервером.  
- **retry** — интервал повторных попыток при ошибках.  
- **expire** — срок устаревания зоны.  
- **minimum** — минимальный TTL для кэша.

## 11. Как защитить зону от скачивания?

Использовать в `named.conf` ограничения:

- ограничение transfer-запросов параметром `allow-transfer {};`;  
- запрет AXFR-запросов;  
- использование TSIG-ключей.

## 12. Какая запись используется при создании почтовых серверов?

Для SMTP применяется запись **MX**.

## 13. Как протестировать работу DNS-сервера?

Через утилиты:

- `dig` — подробный анализ запросов;  
- `host` — быстрые проверки;  
- `nslookup` — диагностика DNS.

## 14. Как запустить, перезапустить или остановить службу?

Через systemd:

- `systemctl start` — запуск;  
- `systemctl restart` — перезапуск;  
- `systemctl stop` — остановка;  
- `systemctl status` — просмотр состояния.

## 15. Как посмотреть отладочную информацию при запуске сервиса?

Использовать:

- `systemctl status <service>`;  
- `journalctl -xe` — подробная ошибка;  
- `journalctl -u <service>` — логи конкретного сервиса.

## 16. Где хранится отладочная информация и как её посмотреть?

Основной журнал — в systemd-логах.  
Просмотр:  

- `journalctl`;  
- `journalctl -f` — в реальном времени;  
- `journalctl -u <service>` — для конкретной службы.

## 17. Как посмотреть, какие файлы использует процесс?

Команды:

- `lsof -p <PID>` — список открытых файлов;  
- `lsof | grep <service>` — все файлы, связанные с сервисом;  
- `ls -l /proc/<PID>/fd` — открытые файловые дескрипторы.

## 18. Примеры работы с сетевыми настройками через nmcli

- просмотр соединений: `nmcli connection show`;  
- изменение DNS: `nmcli connection modify eth0 ipv4.dns 8.8.8.8`;  
- включение/выключение интерфейса: `nmcli device connect eth0`, `nmcli device disconnect eth0`;  
- изменение режима авто-DNS: `nmcli connection modify eth0 ipv4.ignore-auto-dns yes`.

## 19. Что такое SELinux?

SELinux — механизм контроля доступа на уровне ядра, который использует политики безопасности для ограничения действий процессов.

## 20. Что такое контекст SELinux?

Контекст (метка) — набор атрибутов SELinux, определяющих права объекта:  
тип, роль, пользователь, домен процесса.

## 21. Как восстановить контекст SELinux после изменений?

С помощью команды:

- `restorecon -vR <каталог>`.

## 22. Как создать правила SELinux на основе логов?

Использовать утилиты:

- `audit2allow` — создание разрешающего правила по сообщениям аудита;  
- `audit2why` — анализ причин блокировки.

## 23. Что такое булевый переключатель SELinux?

Переключатель (boolean) — параметр политики SELinux, позволяющий включить или отключить определённое поведение без изменения всей политики.

## 24. Как посмотреть список переключателей и их состояние?

Команда:

- `getsebool -a`.

## 25. Как изменить значение переключателя SELinux?

Использовать:

- `setsebool boolean_name on/off`;  
- `setsebool -P boolean_name on/off` — сохранить навсегда.
