---
## Front matter
title: "Отчёт по лабораторной работе 8"
subtitle: "Настройка SMTP-сервера"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---


# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTPсервера.

# Выполнение

## Установка Postfix

На сервере выполняется установка пакетов Postfix и s-nail, после чего система подтверждает успешное добавление компонентов. Затем в межсетевом экране разрешается работа службы SMTP, и это отображается в списке активных сервисов. Выполняется восстановление контекстов SELinux для каталога `/etc`, чтобы устранить возможные нарушения безопасности. Служба Postfix добавляется в автозагрузку и запускается, после чего переходят к её первоначальной настройке.

![Настройка myorigin и проверка Postfix](Screenshot_1.png){ #fig:p1 width=90% }

Отображаются текущие параметры конфигурации Postfix, включая `myorigin` и `mydomain`. Значение `mydomain` корректно соответствует формату `<логин>.net`. Параметр `myorigin` изменяется на значение домена, после чего выполняется повторная проверка, подтверждающая успешное применение настройки. Производится проверка целостности конфигурации Postfix. В процессе исправляется ошибка, связанная с неправильным именем службы при попытке перезагрузки, после чего служба корректно перечитывает конфигурацию.

![Разрешение службы SMTP в firewalld](Screenshot_2.png){ #fig:p2 width=90% }

Просматриваются параметры, отличные от значений по умолчанию, что позволяет убедиться в корректности внесённых изменений. Затем параметр домена задаётся вручную, и система подтверждает обновление значения. Далее отключается поддержка IPv6, оставляя в работе только IPv4. После проверки и перезагрузки службы изменения применяются, и Postfix продолжает корректно функционировать.

![Настройка myorigin и проверка Postfix](Screenshot_3.png){ #fig:p3 width=90% }

## Проверка работы Postfix

На сервере под учётной записью пользователя было отправлено тестовое письмо. После выполнения команды в другом терминале был запущен мониторинг почтовой службы. В журнале `maillog` отобразились строки, подтверждающие успешную доставку сообщения: сервер принял письмо от локального пользователя, сформировал идентификатор сообщения и завершил обработку с параметром `status=sent (delivered to mailbox)`. Это означает, что письмо было корректно доставлено в почтовый ящик.

![Мониторинг доставки письма на сервере](Screenshot_4.png){ #fig:p4 width=90% }

После этого был проверен каталог `/var/spool/mail`, где появился файл пользователя с сохранённым письмом. Просмотр содержимого показал полученное сообщение, что окончательно подтверждает успешную доставку.

![Содержимое почтового ящика на сервере](Screenshot_5.png){ #fig:p5 width=90% }

На виртуальной машине client были установлены Postfix и s-nail, затем в конфигурации Postfix отключён IPv6, оставлен только IPv4. После этого служба была добавлена в автозагрузку и запущена. Система подтвердила успешное включение и запуск службы.

![Установка и запуск Postfix на клиенте](Screenshot_6.png){ #fig:p6 width=90% }

На сервере были просмотрены параметры `inet_interfaces` и `mynetworks`. Затем Postfix было разрешено прослушивать соединения на всех интерфейсах, а в список доверенных сетей добавлены адреса внутренней сети, что позволяет принимать сообщения от клиента. Конфигурация была проверена и перечитана, служба перезапущена.

![Настройка сетевых параметров и перезапуск Postfix на сервере](Screenshot_7.png){ #fig:p7 width=90% }

После настройки клиент отправил второе письмо. В журнале сервера появились строки, подтверждающие доставку: сервер принял соединение с адреса клиента, сформировал идентификатор сообщения и завершил обработку с `status=sent`, что означает успешное получение письма.

![Журнал доставки письма от клиента](Screenshot_8.png){ #fig:p8 width=90% }

В каталоге `/var/spool/mail` на сервере появилась запись с содержимым нового письма от клиента. Данные заголовков и содержимое подтверждают корректную доставку сообщения через Postfix.

![Содержимое доставленного письма от клиента](Screenshot_9.png){ #fig:p9 width=90% }

## Конфигурация Postfix для домена

С клиента было отправлено письмо на доменный адрес пользователя. Однако в журнале почтовой службы на сервере появилось сообщение об ошибке: сервер принял соединение от клиента, но попытка доставить письмо завершилась отказом из-за отсутствия маршрута к хосту. Это отражено в строках `status=bounced` и `status=deferred`, указывающих на невозможность подключения к серверу по порту 25. Таким образом, письмо не было доставлено.

![Журнал доставки с ошибкой](Screenshot_10.png){ #fig:p10 width=90% }

На клиенте была предпринята повторная отправка сообщений, после чего была просмотрена очередь почтовых сообщений. В выходных данных видно, что сообщение зависло в очереди с ошибкой `Connection refused`, что подтверждает недоступность сервера по SMTP в момент отправки.

![Очередь сообщений на клиенте](Screenshot_11.png){ #fig:p11 width=90% }

Для обеспечения доставки писем на доменные адреса была выполнена настройка DNS. В файле прямой DNS-зоны была добавлена MX-запись, указывающая на почтовый сервер `mail.trseidaliev.net`, а также внесены соответствующие A-записи для всех необходимых узлов сети.

![Прямая DNS-зона](Screenshot_12.png){ #fig:p12 width=90% }

Аналогично была обновлена и обратная DNS-зона, куда были добавлены PTR-записи для всех хостов, включая почтовый сервер. Это необходимо для корректной обратной проверки адресов при работе почтовых служб.

![Обратная DNS-зона](Screenshot_13.png){ #fig:p13 width=90% }

После изменения DNS-конфигурации на сервере были внесены корректировки в параметры Postfix. В список получателей, обслуживаемых локально, добавлен домен. Конфигурация проверена, перечитана, восстановлены SELinux-контексты каталогов `/etc` и `/var/named`, после чего DNS-сервер был перезапущен.

![Настройка mydestination и восстановление контекстов](Screenshot_14.png){ #fig:p14 width=90% }

После обновления DNS и Postfix повторная отправка писем привела к успешной доставке. Журнал показывает приём соединения от клиента, принятие письма и запись `status=sent (delivered to mailbox)`, что подтверждает успешную доставку.

![Журнал успешной доставки](Screenshot_15.png){ #fig:p15 width=90% }

Письмо также появилось в почтовом ящике пользователя на сервере, что подтверждается просмотром содержимого файла в каталоге `/var/spool/mail`.

![Полученное письмо после исправления конфигурации](Screenshot_16.png){ #fig:p16 width=90% }

## Внесение изменений в настройки внутреннего окружения виртуальной машины

В рамках обновления инфраструктуры были созданы два конфигурационных скрипта: один для сервера, включающий установку пакетов, настройку Postfix, сетевые параметры и SELinux; второй — для клиента, содержащий минимальные настройки Postfix, включая переключение на IPv4 и запуск службы.

![Скрипт настройки Postfix на сервере](Screenshot_17.png){ #fig:p17 width=90% }

![Скрипт настройки Postfix на клиенте](Screenshot_18.png){ #fig:p18 width=90% }

# Заключение

В ходе выполнения работы:

- установлен и настроен почтовый сервер Postfix на виртуальных машинах server и client;
- выполнена отправка писем с локального хоста и удалённого клиента с последующим анализом доставки;
- проведён мониторинг работы почтовой службы через журнал maillog и очередь сообщений postqueue;
- выявлены и устранены ошибки, связанные с отсутствием MX-записей и сетевой недоступностью SMTP-порта;
- настроены прямые и обратные DNS-зоны, добавлены необходимые A-, PTR- и MX-записи для корректной маршрутизации почтовых сообщений;
- обновлены параметры Postfix (mydestination, mydomain, inet_interfaces, mynetworks), обеспечивающие доставку почты на доменные адреса;
- восстановлены контексты SELinux и перезапущены службы для применения изменений;
- успешно выполнена автоматизация конфигурации через провижион-скрипты, в которые добавлены все необходимые настройки почтового сервера.



# Контрольные вопросы

## 1. В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?

Конфигурация Postfix находится в каталоге **/etc/postfix**.  
Основной конфигурационный файл — **main.cf**, в котором задаются параметры работы почтового сервера. Дополнительные настройки могут быть в файле **master.cf**, который отвечает за управление службами Postfix.

## 2. Каким образом можно проверить корректность синтаксиса в конфигурационном файле Postfix?

Для проверки синтаксиса используется встроенная команда Postfix:

- **postfix check** — проверяет корректность настроек, структуру каталогов, синтаксис параметров.  
Если в конфигурации есть ошибки, команда сообщит о них в выводе или в журнале `/var/log/maillog`.

## 3. В каких параметрах конфигурации Postfix требуется внести изменения для настройки возможности отправки писем не на локальный хост, а на доменные адреса?

Для корректной отправки писем на доменные адреса необходимо изменить несколько ключевых параметров:

- **mydestination** — добавить домен, чтобы сервер принимал письма, предназначенные для него.
- **mydomain** — установить собственный домен, например `trseidaliev.net`.
- **myorigin** — задать доменную часть, используемую при отправке локальных сообщений.
- **mynetworks** — разрешить отправку писем от доверенных хостов, например локальной сети.
- Наличие MX-записей в DNS — необходимо для маршрутизации почты на почтовый сервер.

Эти параметры позволяют отправлять почту на доменные адреса и корректно принимать сообщения, приходящие по SMTP.

## 4. Приведите примеры работы с утилитой mail по отправке письма, просмотру имеющихся писем, удалению письма.

Примеры работы с `mail`:

- **Отправка письма**:  
  `echo . | mail -s "test" user@example.net`

- **Просмотр всех писем пользователя**:  
  `mail`  
  (внутри можно просматривать письма по номерам)

- **Просмотр конкретного письма**:  
  внутри интерфейса mail:  
  `1` — открыть первое письмо

- **Удаление письма**:  
  внутри mail:  
  `d 1` — удалить письмо №1  
  `q` — выйти с сохранением изменений

- **Удаление всех писем**:  
  внутри mail:  
  `d *`

## 5. Приведите примеры работы с утилитой postqueue. Как посмотреть очередь сообщений? Как определить число сообщений в очереди? Как отправить все сообщения, находящиеся в очереди? Как удалить письмо из очереди?

Работа с `postqueue`:

- **Посмотреть очередь сообщений**:  
  `postqueue -p`  
  Отображает список писем, находящихся в очереди.

- **Определить число сообщений в очереди**:  
  `postqueue -p | grep -c '^[A-F0-9]'`  
  Каждое сообщение имеет идентификатор, начинающийся с шестнадцатеричного символа.

- **Отправить все сообщения в очереди**:  
  `postqueue -f`  
  Или аналогичная команда:  
  `postfix flush`

- **Удалить конкретное письмо из очереди**:  
  `postsuper -d <ID>`  
  где `<ID>` — идентификатор сообщения, например `A1B2C3D4E5`.

- **Удалить всю очередь**:  
  `postsuper -d ALL`

Эти команды позволяют управлять очередью писем Postfix и исправлять ситуации, когда сообщения не отправляются из-за ошибок конфигурации или сетевых проблем.
