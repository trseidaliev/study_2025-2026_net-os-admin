---
## Front matter
title: "Отчёт по лабораторной работе 10"
subtitle: "Расширенные настройки SMTP-сервера"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---


# Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.

# Выполнение

## Настройка LMTP в Dovecot

Для включения поддержки протокола LMTP был изменён файл `dovecot.conf`, где в параметр `protocols` добавлен `lmtp`. Это обеспечивает возможность приёма сообщений от Postfix через локальный LMTP-сокет.

![Добавление протокола LMTP в Dovecot](Screenshot_1.png){ #fig:001 width=80% }

В файле `10-master.conf` был переопределён сервис `lmtp`. В конфигурации указано расположение Unix-сокета, через который Postfix передаёт сообщения, а также заданы права доступа и принадлежность к пользователю и группе `postfix`.

![Настройка сервиса LMTP в 10-master.conf](Screenshot_2.png){ #fig:002 width=75% }

В файле `10-auth.conf` задано использование локальной части логина без доменной части. Это позволяет корректно сопоставлять имя пользователя с его локальной учётной записью.

![Настройка auth_username_format](Screenshot_3.png){ #fig:003 width=80% }

Postfix был перенастроен на передачу сообщений не напрямую, а через LMTP-сокет Dovecot. После внесения изменений службы Postfix и Dovecot были перезапущены для применения конфигурации.

При отправке тестового письма в журнале фиксировались следующие этапы:

- приём письма Postfix от клиента;
- передача сообщения локальному транспортному агенту;
- вызов LMTP-доставки через сокет `/var/spool/postfix/private/dovecot-lmtp`;
- подтверждение Dovecot о сохранении сообщения в INBOX;
- отчёт Postfix об успешной доставке.

![Логи доставки письма через LMTP](Screenshot_4.png){ #fig:004 width=95% }

**Пояснение по логам:**

Передача письма успешно прошла по цепочке: клиент → Postfix → LMTP → Dovecot.  
Ключевая строка `saved mail to INBOX` подтверждает корректную доставку, а статус `250 2.0.0` — успешное завершение транзакции.

Просмотр содержимого почтового ящика пользователя подтвердил наличие тестового письма, доставленного через LMTP.

![Просмотр Maildir пользователя](Screenshot_5.png){ #fig:005 width=80% }

Письмо успешно доставлено, что подтверждает корректную интеграцию Postfix и Dovecot через LMTP.

## Настройка SMTP-аутентификации

В файле `10-master.conf` была добавлена конфигурация службы `auth`, обеспечивающая взаимодействие Postfix и Dovecot при проверке пользовательских учетных данных.

![Фрагмент настройки службы auth](Screenshot_6.png){ #fig:006 width=70% }

Построчное пояснение:

- `service auth {` — начало блока настроек службы аутентификации Dovecot.
- `unix_listener auth-userdb {` — настройка сокета, через который внутренние процессы Dovecot получают информацию о пользователях.
- `mode = 0600` — доступ только для владельца сокета.
- `user = dovecot` — владельцем сокета является пользователь `dovecot`.
- `}` — закрытие блока `auth-userdb`.
- `unix_listener /var/spool/postfix/private/auth {` — сокет, используемый Postfix для SASL-аутентификации через Dovecot.
- `group = postfix` — группа владельца сокета — `postfix`, что позволяет Postfix обращаться к нему.
- `user = postfix` — владельцем сокета является пользователь Postfix.
- `mode = 0660` — разрешение на чтение и запись для владельца и группы.
- `}` — закрытие блока Postfix-сокета.
- `}` — завершение определения службы `auth`.

В Postfix была включена поддержка SASL-аутентификации через Dovecot и указан путь к соответствующему сокету.

![Настройка параметров SASL через postconf](Screenshot_7.png){ #fig:007 width=90% }

В настройках Postfix заданы параметры, регулирующие приём писем:

- `reject_unknown_recipient_domain` — отклоняет письма, если домен получателя не существует.
- `permit_mynetworks` — разрешает приём писем от доверенных IP-адресов.
- `reject_non_fqdn_recipient` — отклоняет адреса получателя без полного доменного имени.
- `reject_unauth_destination` — запрещает использовать сервер как открытый релей; принимает письма только для локальных доменов.
- `reject_unverified_recipient` — отклоняет письма, если проверка существования пользователя невозможна или неуспешна.
- `permit` — разрешает обработку после прохождения всех предыдущих проверок.

Эти параметры предотвращают использование сервера в качестве SMTP-relay и обеспечивают проверку корректности адресов.

В Postfix адрес доверенной сети ограничен только локальным хостом:

`mynetworks = 127.0.0.0/8`

Это гарантирует, что сервер принимает письма без аутентификации только от самого себя.

В файле `master.cf` в определении службы SMTP добавлены параметры:

- включение SASL-аутентификации (`smtpd_sasl_auth_enable=yes`);
- изменение ограничений получателей для разрешения авторизованных пользователей (`permit_sasl_authenticated`).

![Фрагмент master.cf с изменёнными параметрами](Screenshot_8.png){ #fig:008 width=90% }

Для проверки работы аутентификации на клиентской машине было установлено средство `telnet`, а затем сгенерирована строка авторизации формата base64.

После подключения к серверу:

- сервер сообщает поддерживаемые расширения SMTP;
- выполняется команда `EHLO test`;
- производится проверка аутентификации командой `AUTH PLAIN <строка>`.

На скриншоте показано успешное прохождение аутентификации:

![Проверка авторизации через telnet](Screenshot_9.png){ #fig:009 width=90% }

Сервер вернул код `235 2.7.0 Authentication successful`, подтверждающий корректную работу SMTP-аутентификации.

## Настройка SMTP over TLS

Для настройки TLS использовались временные сертификаты Dovecot.  
Файлы сертификата и ключа были перенесены в системные каталоги `/etc/pki/tls/certs` и `/etc/pki/tls/private` для корректной работы SELinux.

На скриншоте видно выполнение копирования и настройку Postfix путём указания сертификата, приватного ключа, каталога кеширования TLS-сессий, а также уровня безопасности:

![Копирование сертификатов и настройка параметров TLS в Postfix](Screenshot_10.png){ #fig:010 width=95% }

После внесения параметров Postfix начинает принимать TLS-соединения и использовать шифрование при работе по SMTP.

Для запуска SMTP-сервиса с поддержкой TLS и аутентификации на 587-м порту в файл `master.cf` были внесены изменения.

Основной SMTP-сервис на порту 25 оставлен в минимальной конфигурации:

`smtp inet n - n - - smtpd`

Добавлена новая служба submission:

- работает на порту 587;
- требует применение шифрования (опция `encrypt`);
- включает SASL-аутентификацию;
- использует ограничивающие правила для адресов получателя, предотвращающие open relay.

Фрагмент изменённого файла:

![Изменения в master.cf для службы submission](Screenshot_11.png){ #fig:011 width=95% }

Чтобы разрешить работу службы smtp-submission, в firewall были добавлены соответствующие правила. Сервис стал доступен и после перезагрузки конфигурации межсетевой экран учитывает постоянное разрешение.

С клиента выполнялось подключение к SMTP-серверу по порту 587 с использованием STARTTLS:

`openssl s_client -starttls smtp -crlf -connect server.user.net:587`

После установления защищённого канала были выполнены:

- команда EHLO;
- попытка аутентификации через механизм AUTH PLAIN.

Скриншот демонстрирует успешную TLS-сессию и подтверждённую аутентификацию:

![Проверка SMTP over TLS через openssl и telnet](Screenshot_12.png){ #fig:012 width=95% }

В почтовом клиенте Evolution был настроен SMTP-сервер со следующими параметрами:

- порт: 587;
- метод шифрования: STARTTLS;
- тип аутентификации: PLAIN.

Настройки отображены на скриншоте:

![Настройки SMTP в Evolution](Screenshot_13.png){ #fig:013 width=80% }

После настройки почтовые сообщения успешно отправлялись через TLS-защищённый SMTP-канал.

В клиентском интерфейсе Evolution отображаются входящие письма, отправленные через TLS-канал. Все они доставлены корректно:

![Полученные письма в Evolution](Screenshot_14.png){ #fig:014 width=80% }

Мониторинг `/var/log/maillog` показал корректную работу цепочки:

1. клиент → Postfix (через TLS);
2. передача сообщения в LMTP-службу;
3. Dovecot принимает письмо и сохраняет его в INBOX;
4. Postfix подтверждает успешную доставку.

Логи демонстрируют успешную аутентификацию и использование LMTP для хранения почты:

![Фрагмент логов Postfix и Dovecot](Screenshot_15.png){ #fig:015 width=95% }

## Внесение изменений в конфигурацию внутреннего окружения

Для сохранения всех модификаций в инфраструктуре Vagrant были перенесены обновлённые конфигурации в каталог `/vagrant/provision/server/`.

Скрипт `mail.sh` был дополнен параметрами для расширенной настройки SMTP и TLS.

Пример фрагмента обновлённого скрипта:

![Часть обновлённого provisioning-скрипта](Screenshot_16.png){ #fig:016 width=85% }

Дополнительно создан вариант минимального provisioning-скрипта для клиента, включающий установку Evolution и telnet:

![Минимальный provisioning-скрипт для клиента](Screenshot_17.png){ #fig:017 width=60% }

# Заключение

В ходе выполнения работы:

- настроен SMTP-сервер Postfix с поддержкой аутентификации пользователей через Dovecot;
- реализована передача почты посредством LMTP-сервиса Dovecot;
- включена и проверена работа TLS-шифрования для SMTP (порт 587, STARTTLS);
- выполнена настройка firewall для служб smtp и smtp-submission;
- протестирована SMTP-аутентификация как через telnet/openssl, так и через почтовый клиент Evolution;
- обновлены конфигурации Postfix и Dovecot в каталоге provisioning для автоматизации развёртывания.

# Контрольные вопросы

## 1. Приведите пример задания формата аутентификации пользователя в Dovecot в форме логина с указанием домена.

Для использования полного адреса электронной почты (логин + домен) можно задать:

`auth_username_format = %n@%d`

В этом случае Dovecot будет ожидать логин в виде `user@domain`, не отбрасывая доменную часть.

## 2. Какие функции выполняет почтовый Relay-сервер?

Почтовый Relay-сервер выполняет следующие задачи:

- принимает письма от отправителей и передаёт их другому серверу SMTP для дальнейшей доставки;
- маршрутизирует почтовый трафик между доменами и почтовыми системами;
- может использоваться как промежуточный узел для фильтрации, антивирусной проверки или балансировки нагрузки;
- обеспечивает доставку сообщений в случае временной недоступности конечного сервера, помещая почту в очередь.

## 3. Какие угрозы безопасности могут возникнуть в случае настройки почтового сервера как Relay-сервера?

Неправильно настроенный Relay-сервер представляет серьёзную угрозу:

- **Использование как open relay** — злоумышленники смогут рассылать спам через сервер без ограничений.
- **Включение в чёрные списки (RBL)** — провайдеры и другие почтовые сервера начнут блокировать почту с данного домена/узла.
- **Повышенная нагрузка на сервер** — массовая спам-рассылка быстро исчерпает ресурсы системы.
- **Компрометация доверия к домену** — почта домена будет расцениваться как вредоносная, что приведёт к блокировкам и ухудшению доставки.
- **Риск DoS-атак** — спам-боты могут перегрузить очереди обработки писем.

Поэтому строгие ограничения (`reject_unauth_destination`, `permit_mynetworks`, `permit_sasl_authenticated`) обязательны для защиты SMTP-сервера.

