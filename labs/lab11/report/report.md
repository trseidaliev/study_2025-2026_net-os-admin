---
## Front matter
title: "Отчёт по лабораторной работе 11"
subtitle: "Настройка безопасного удалённого доступа по протоколу SSH"
author: "Сейдалиев Тагиетдин Ровшенович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---

# Цель работы

Приобретение практических навыков по настройке удалённого доступа к серверу с помощью SSH.

# Выполнение

## Запрет удалённого доступа по SSH для пользователя root

С клиента выполняется попытка подключения к серверу от имени root.  
На экране отображается запрос пароля, однако даже при корректном вводе система не допускает пользователя к удалённому доступу.  
SSH-сервер отклоняет аутентификацию, что видно на скриншоте ниже.

![Попытка подключения под пользователем root](Screenshot_1.png){ #fig:001 width=80% }

Такое поведение является ожидаемым: по умолчанию в конфигурации SSH вход root-пользователя запрещён.  
В системном журнале на сервере фиксируются неоднократные отказанные попытки входа.

В файле конфигурации sshd присутствует параметр, запрещающий удалённый вход root.  
Это подтверждается соответствующей строкой, представленной на скриншоте.

![Фрагмент sshd_config с запретом root](Screenshot_2.png){ #fig:002 width=70% }

После сохранения конфигурации служба SSH перезапускается для применения изменений.

После перезапуска SSH-сервера попытка входа под пользователем root вновь завершается отказом.  
Сервер не принимает пароль и завершает процедуру аутентификации.

![Отказ в доступе после перезапуска SSH](Screenshot_3.png){ #fig:003 width=80% }

Удалённый доступ под root заблокирован политикой безопасности, и данное поведение является корректным.

## Ограничение списка пользователей для SSH

Выполняется доступ к серверу под учётной записью trseidaliev.  
Аутентификация проходит успешно, и пользователь получает доступ к системе.

![Успешный вход пользователя trseidaliev](Screenshot_4.png){ #fig:004 width=80% }

Это означает, что сервер разрешает вход всем локальным пользователям, кроме root, если иное не задано в конфигурации.

В конфигурацию sshd добавляется строка, разрешающая доступ только пользователю vagrant.  
Фрагмент файла представлен ниже.

![Правило AllowUsers vagrant](Screenshot_5.png){ #fig:005 width=70% }

После перезапуска SSH-сервера правила аутентификации вступают в силу.

Теперь при попытке аутентификации пользователь trseidaliev получает отказ.  
Сервер блокирует доступ ещё до проверки пароля, так как учётная запись отсутствует в списке разрешённых.

![Отказ в доступе пользователю не из списка AllowUsers](Screenshot_6.png){ #fig:006 width=80% }

Это подтверждает, что директива ограничивает круг пользователей, имеющих право на удалённый вход.

В список разрешённых добавляется второй пользователь — trseidaliev.  
Фрагмент обновлённой конфигурации показан на скриншоте.

![Разрешение двух пользователей в AllowUsers](Screenshot_7.png){ #fig:007 width=70% }

После применения изменений вход пользователя trseidaliev снова выполняется успешно.

![Успешное подключение после добавления пользователя в AllowUsers](Screenshot_8.png){ #fig:008 width=80% }

Это подтверждает корректную работу механизма ограничения и разрешения доступа через директиву AllowUsers.

## Настройка дополнительных портов для удалённого доступа по SSH

В конфигурационный файл `/etc/ssh/sshd_config` добавлены строки, указывающие службе SSH прослушивать два порта — стандартный 22 и дополнительный 2022.  
Это позволяет сохранить доступ к серверу даже при ошибках в конфигурации:

![Добавление порта 2022](Screenshot_9.png){ #fig:009 width=70% }

После сохранения файла служба SSH была перезапущена.

При просмотре расширенного статуса работы sshd видно, что процесс не смог открыть порт 2022.  
Система выводит сообщение об ошибке, указывающее на отказ доступа:

![Ошибка Permission denied при открытии порта 2022](Screenshot_10.png){ #fig:010 width=80% }

Суть сообщения:  
*SELinux блокирует попытку сервиса sshd открыть нестандартный порт, поскольку для него не назначена корректная SELinux-метка.*

Для разрешения sshd использовать порт 2022 была назначена корректная метка SELinux и открыт порт в межсетевом экране.  
После выполнения необходимых команд sshd успешно стартовал и начал прослушивать оба порта:

![Успешное прослушивание порта 22 и 2022](Screenshot_11.png){ #fig:011 width=80% }

Теперь в статусе видно, что сервер прослушивает соединения одновременно на двух портах.

Выполнено подключение к серверу от имени пользователя trseidaliev через стандартный порт 22.  
Аутентификация прошла успешно, доступ к системе получен.

После выполнения команды `sudo -i` получен доступ root.  
Выход из сеанса выполнен двумя командами logout.

Аналогичное подключение выполнено, но с указанием дополнительного порта:

![Успешное подключение через порт 2022](Screenshot_12.png){ #fig:013 width=80% }

Вход через порт 2022 проходит корректно, что подтверждает правильную работу SELinux-меток и правил firewall.  
Аутентификация завершается успешно, доступ root также получается через `sudo -i`.

## Настройка удалённого доступа по SSH по ключу

В конфигурацию sshd добавлен параметр, разрешающий вход по ключам:

![Включение PubkeyAuthentication](Screenshot_13.png){ #fig:014 width=70% }

После внесения изменений sshd был перезапущен.

На клиентской машине была создана пара SSH-ключей.  
Закрытый ключ помещён в файл `~/.ssh/id_rsa`, открытый — в `~/.ssh/id_rsa.pub`.

Открытый ключ передан на сервер с помощью команды, которая автоматически добавляет его в файл `~/.ssh/authorized_keys` пользователя:

После успешной установки ключа система уведомляет о количестве добавленных ключей.

Далее выполнено подключение к серверу по SSH без ввода пароля:

![Успешное подключение по ключу](Screenshot_14.png){ #fig:016 width=80% }

Аутентификация происходит автоматически — сервер использует ранее установленные ключи, что подтверждает корректную настройку.

## Организация туннелей SSH, перенаправление TCP-портов

Перед созданием туннеля выполнялась проверка открытых TCP-соединений.  
В момент проверки список был пуст, что означает отсутствие активных прослушивающих или установленных TCP-соединений.

Это дало возможность обращаться к веб-серверу, работающему на удалённой машине, через локальный порт.

После запуска туннеля повторная проверка TCP-соединений показала появившиеся записи:

![Отображение TCP-соединений после создания туннеля](Screenshot_15.png){ #fig:017 width=80% }

Список содержит:

- установленное SSH-соединение между клиентом и сервером,
- процесс, слушающий порт `localhost:webcache`, соответствующий локальному перенаправлению.

Это подтверждает корректную работу SSH-туннеля.

После открытия браузера и перехода по адресу `localhost:8080` отобразилась стартовая страница, обслуживаемая сервером:

![Проверка доступа к веб-серверу через SSH-туннель](Screenshot_16.png){ #fig:018 width=80% }

Это подтверждает, что все HTTP-запросы успешно перенаправляются через SSH-соединение.

## Запуск консольных приложений через SSH

Удалённый вызов команды hostname корректно возвращает имя сервера:

![hostname через SSH](Screenshot_17.png){ #fig:019 width=80% }

Команда удалённого просмотра каталога выводит содержимое домашнего каталога пользователя:

Удалённый запуск консольной почтовой программы показывает содержимое каталога Maildir:

![Просмотр почты через SSH](Screenshot_18.png){ #fig:021 width=80% }

## Разрешение X11-переадресации на сервере

В конфигурации sshd был разрешён вывод графических приложений на сторону клиента:

![Изменение настроек X11Forwarding](Screenshot_19.png){ #fig:022 width=70% }

После изменения sshd был перезапущен.

При попытке запустить графическое приложение возникла ошибка:

![Ошибка X11 перенаправления](Screenshot_20.png){ #fig:023 width=80% }

Смысл ошибки:

- сервер разрешает X11-forwarding,
- но на клиенте отсутствует переменная DISPLAY,
- значит X-сервер на клиентской машине не запущен или не настроен.

Поэтому передавать графический интерфейс невозможно.

## Внесение изменений в настройки внутреннего окружения виртуальной машины

В каталоге `/vagrant/provision/server/` был создан каталог `ssh/etc/ssh`, куда помещён действующий конфигурационный файл SSH-демона.

После создания файла `ssh.sh` ему были назначены права на исполнение.  
Внутри файла содержится автоматизация всех изменений, сделанных вручную:

![Содержимое файла ssh.sh](Screenshot_21.png){ #fig:024 width=80% }

# Заключение

В ходе выполнения работы:

- настроены ограничения доступа по SSH, включая запрет входа для root и разрешение соединений только определённым пользователям;
- реализована работа SSH-сервера через два порта, устранены ограничения SELinux и настроен межсетевой экран для дополнительного порта 2022;
- проверена возможность подключения по SSH как по стандартному, так и по дополнительному порту;
- выполнена настройка аутентификации по открытым ключам и подтверждена успешная работа входа без пароля;
- опробовано создание SSH-туннелей и локальной переадресации портов, обеспечив доступ к веб-сервису через защищённое соединение;
- выполнен удалённый запуск консольных приложений и просмотр почты через SSH, изучены ограничения при использовании X11-перенаправления;
- подготовлены изменения во внутреннем окружении виртуальной машины, включая создание провижининг-скрипта для автоматической настройки SSH.

Результаты лабораторной работы подтвердили корректность настройки SSH и связанных механизмов безопасности, а также продемонстрировали практическое применение туннелирования и аутентификации по ключам.

# Контрольные вопросы

## 1. Вы хотите запретить удалённый доступ по SSH на сервер пользователю root и разрешить доступ пользователю alice. Как это сделать?

Чтобы запретить вход по SSH для root и разрешить его пользователю alice, необходимо изменить файл конфигурации sshd на сервере.

В конфигурацию `/etc/ssh/sshd_config` вносятся строки:

- `PermitRootLogin no` — запрещает вход root-пользователя;
- `AllowUsers alice` — разрешает вход только пользователю alice.

После изменения файл сохраняется, и служба SSH перезапускается.  
В результате удалённый вход root становится недоступным, а пользователь alice получает полный доступ по SSH.

## 2. Как настроить удалённый доступ по SSH через несколько портов? Для чего это может потребоваться?

Чтобы настроить SSH на работу через несколько портов, в конфигурации sshd последовательно добавляются строки вида:

```
Port 22
Port 2022
```

После перезапуска SSH-сервера он начинает прослушивать указанные порты одновременно.

Такое решение применяется:

- для обеспечения резервного доступа, если основной порт становится недоступен;
- для тестирования изменений конфигурации перед их окончательным применением;
- для обхода ограничений межсетевых экранов, блокирующих нестандартные порты;
- для повышения безопасности путём изменения стандартного порта 22.

## 3. Какие параметры используются для создания туннеля SSH, когда команда ssh устанавливает фоновое соединение и не ожидает какой-либо конкретной команды?

Для создания фонового SSH-туннеля применяются параметры:

- `-f` — переводит SSH в фоновый режим после аутентификации;
- `-N` — отключает выполнение удалённой команды (SSH создаёт только туннель);
- `-L` — задаёт локальную переадресацию портов.

Фоновое соединение не открывает удалённую оболочку и служит только каналом для передачи данных через SSH-туннель.

## 4. Как настроить локальную переадресацию с локального порта 5555 на порт 80 сервера server2.example.com?

Для создания локального туннеля используется конструкция перенаправления портов:

```
-L 5555:localhost:80
```

Она связывает локальный порт 5555 с портом 80 удалённого сервера.  
После установления SSH-соединения браузер, открывающий `localhost:5555`, фактически обращается к веб-серверу server2.example.com.

## 5. Как настроить SELinux, чтобы позволить SSH связываться с портом 2022?

Чтобы разрешить sshd открывать нестандартный порт 2022, необходимо назначить ему корректную SELinux-метку:

```
semanage port -a -t ssh_port_t -p tcp 2022
```

После выполнения команды SELinux разрешает службе SSH слушать этот порт.  
Только после этого sshd сможет успешно запуститься, если в конфигурации указан порт 2022.

## 6. Как настроить межсетевой экран на сервере, чтобы разрешить входящие подключения по SSH через порт 2022?

Для открытия порта 2022 в firewall выполняются две команды:

- временное открытие:  
  `firewall-cmd --add-port=2022/tcp`
- постоянное открытие (после перезагрузки сохраняется):  
  `firewall-cmd --add-port=2022/tcp --permanent`

После изменения конфигурации firewall перезагружается, и порт становится доступен для входящих SSH-подключений.

